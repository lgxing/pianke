package com.lamp.gxpk;

import java.util.List;

import com.lamp.gxpk.adapter.CommentlvAdapter;
import com.lamp.gxpk.base.BaseActivity;
import com.lamp.gxpk.base.BaseInterface;
import com.lamp.gxpk.bean.CommentBean;
import com.lamp.gxpk.bean.UserBean;
import com.lamp.gxpk.myview.MyImageView;
import com.lidroid.xutils.ViewUtils;
import com.lidroid.xutils.view.annotation.ViewInject;
import com.lidroid.xutils.view.annotation.event.OnClick;

import android.os.Bundle;
import android.view.View;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;
import cn.bmob.v3.BmobQuery;
import cn.bmob.v3.BmobUser;
import cn.bmob.v3.listener.FindListener;
import cn.bmob.v3.listener.SaveListener;
import io.vov.vitamio.LibsChecker;
import io.vov.vitamio.widget.MediaController;
import io.vov.vitamio.widget.VideoView;

public class PlayVideoActivity extends BaseActivity implements BaseInterface {

	@ViewInject(R.id.act_playvideo_video)
	private VideoView video;// 视频播放
	@ViewInject(R.id.act_playvideo_usericon)
	private MyImageView iconimg;// 用户头像
	@ViewInject(R.id.act_playvideo_username)
	private TextView tvuname;// 用户昵称
	@ViewInject(R.id.act_playvideo_speak)
	private TextView tvspeak;// 用户发布视频时发表的言论
	@ViewInject(R.id.act_playvideo_lovenum)
	private TextView tvlovenum;// 收藏该视频的人数
	@ViewInject(R.id.act_playvideo_lovenum)
	private TextView tvCommentnum;// 评论该视频的人数
	@ViewInject(R.id.act_playvideo_content)
	private EditText etcontent;// 评论的内容
	@ViewInject(R.id.act_playvideo_lv)
	private ListView commentlv;// 评论列表
	
	private UserBean ub;//当前登录用户
	@Override
	protected void onCreate(Bundle arg0) {
		super.onCreate(arg0);
		initViews();
		initDatas();
		initOper();
	}

	@Override
	public void initViews() {
		setContentView(R.layout.act_playvideo);
		ViewUtils.inject(this);
	}

	@Override
	public void initDatas() {
		
		ub = BmobUser.getCurrentUser(this, UserBean.class);
		//查询该视频所有评论
		getVideoComment();

	}

	@Override
	public void initOper() {
		
		// 检测是否有支持库, 没有的话会自动安装
		if (LibsChecker.checkVitamioLibs(this)) {
			// 设置资源本地路径
			video.setVideoPath("sdcard/xxx.flv");
			// 添加控制器 (默认控制器)
			video.setMediaController(new MediaController(this));
			// 开始播放
			video.start();
		}
	}

	// 该方法用于查询当前视频所有的评论及设置评论的人数
	private void getVideoComment() {

		BmobQuery<CommentBean> query = new BmobQuery<CommentBean>();
		// TODO 添加视频Id
		query.addWhereEqualTo("objectId", "视频ID");
		query.order("-createdAt");
		query.findObjects(getAct(), new FindListener<CommentBean>() {

			@Override
			public void onSuccess(List<CommentBean> arg0) {
				// 查询成功以后设置评论的总人数
				if (arg0 == null) {
					tvCommentnum.setText("0人评论");
				} else {
					tvCommentnum.setText(arg0.size() + "人评论");
				}
				// 设置数据源
				commentlv.setAdapter(new CommentlvAdapter(getAct(), arg0));
			}

			@Override
			public void onError(int arg0, String arg1) {

			}
		});

	}
	//发表对该视频评论的操作
	@OnClick(R.id.act_playvideo_fabu)
	public void fabuOnClick(View v){
		//判断评论内容是否为空
		String content = etcontent.getText().toString().trim();
		if (content==null) {
			toastShort("请输入您评论的内容");
			return;
		}
		//上传服务器
		CommentBean cbean = new CommentBean();
		cbean.setContent(content);
		cbean.setNickname(ub.getNickname());
		cbean.setNickname(ub.getUsericon().getFileUrl(this));
		//TODO 完善视频ID
		cbean.setVideoId("视频ID");
		cbean.save(getAct(), new SaveListener() {
		
			@Override
			public void onSuccess() {
				toastShort("发表成功");
				//刷新评论
				getVideoComment();
			}
			
			@Override
			public void onFailure(int arg0, String arg1) {
				logE("评论失败"+arg1);
			}
		});
	}
}
